# ZapLink

ZapLink is a lightweight ATSC/DVB backend that scans channels, builds an EPG from PSIP tables, and serves live streams and guide data over HTTP for clients like Jellyfin.

## Features
- **Automatic Channel Scan**: Parallel tuner scanning with RabbitEars zip-code hints and optional VHF skipping.
- **Robust EPG**: Background EPG collection with valid XMLTV output supporting Jellyfin Series Recording.
- **Live Streaming**: Supports software and hardware transcoding (QSV, VAAPI, NVENC) via FFmpeg.
- **Simple API**: HTTP endpoints for M3U playlists and XMLTV guide data.

## Requirements
- Linux with DVB/ATSC hardware (`/dev/dvb/adapter*`).
- `dvbv5-scan` and `dvbv5-zap` (from `v4l-utils` or `dvb-apps`).
- `ffmpeg` (for streaming/transcoding).
- SQLite3 (development headers).
- `curl` (for scan hints).
- `make` and `gcc`.

## Build & Install

### Standard Build
Build using system libraries:
```sh
make
sudo make install
```

### Local Build (Bundled Deps)
If system SQLite is missing/old, use the setup script and local build target:
```sh
./support/setup_env.sh
make
sudo make install
```

### Installation Details
`make install` will:
- Install binary to `/opt/zaplink/zaplink`.
- Install `huffman.bin` to `/opt/zaplink/`.
- Create a `zaplink` user.
- Install and enable the `zaplink.service`.

**Note:** `channels.conf` is *not* overwritten or installed by default to prevent valid configs from being lost. Use the `-s` flag to generate it if missing, or copy it manually if you have a backup.

## Usage

### Managing the Service
Start, stop, or check the status of the ZapLink engine:
```sh
sudo systemctl start zaplink
sudo systemctl stop zaplink
sudo systemctl status zaplink
```
Logs can be viewed via journalctl:
```sh
sudo journalctl -u zaplink -f
```

### Manual Usage
You can run the binary directly for testing:
```sh
./build/zaplink -v
```
Flags:
- `-p <port>`: HTTP port (default `18392`).
- `-v`: Verbose logging.
- `-t`: Run transcoding benchmark.
- `-s`: Force channel rescan.

## HTTP Endpoints
Base URL: `http://<host>:18392`

- `GET /playlist.m3u`: M3U playlist for Jellyfin/VLC.
- `GET /xmltv.xml`: XMLTV EPG data (Jellyfin compatible).
- `GET /stream/<channel>`: Live stream (e.g., `/stream/15.1`).

### Streaming Parameters
All parameters are optional and can be appended to stream URLs or the playlist URL.

| Parameter | Values | Default | Description |
|-----------|--------|---------|-------------|
| `backend` | `software`, `qsv`, `nvenc`, `vaapi` | `software` | Hardware acceleration backend |
| `codec` | `copy`, `h264`, `hevc`, `av1` | `copy` | Video codec (copy = passthrough) |
| `bitrate` | Integer (kbps) | Auto | Target video bitrate (e.g., `6000`) |
| `audio` | `2`, `6`, `5.1` | `2` | Audio channels (stereo or 5.1 surround) |

### Streaming Modes

**Passthrough Mode (Default)**
When no `codec` is specified (or `codec=copy`), the raw MPEG-TS stream from dvbv5-zap is piped directly to the client without any transcoding. This provides:
- Zero CPU usage for video processing
- Original video/audio quality preserved
- Lowest possible latency

**Transcoding Mode**
When a codec is specified (`h264`, `hevc`, `av1`), FFmpeg processes the stream with:
- Low-latency encoder presets (ultrafast/zerolatency)
- Deinterlacing filters
- AAC audio encoding (stereo by default, or 5.1 with `audio=6`)
- MPEG-TS muxer optimizations for live streaming

### Examples

1. **Passthrough (Default)** - zero CPU, original quality:
   ```sh
   curl "http://localhost:18392/stream/15.1" > out.ts
   ```

2. **Software Transcode to H.264** (stereo audio):
   ```sh
   curl "http://localhost:18392/stream/15.1?codec=h264" > out.ts
   ```

3. **Hardware Transcode (Intel QSV) to H.264 at 6Mbps**:
   ```sh
   curl "http://localhost:18392/stream/15.1?backend=qsv&codec=h264&bitrate=6000" > out.ts
   ```

4. **Hardware Transcode (VA-API) to HEVC with 5.1 audio**:
   ```sh
   curl "http://localhost:18392/stream/15.1?backend=vaapi&codec=hevc&audio=6" > out.ts
   ```

5. **NVIDIA NVENC to H.264**:
   ```sh
   curl "http://localhost:18392/stream/15.1?backend=nvenc&codec=h264" > out.ts
   ```

## Jellyfin Setup
To use ZapLink with Jellyfin:
1. Go to **Dashboard** > **Live TV**.
2. Add **Tuner Device** (Select **M3U Tuner**):
   - **File or URL**: `http://<ip>:18392/playlist.m3u`
   - *Tip: Append parameters to apply them to all channels:*
     `http://<ip>:18392/playlist.m3u?backend=qsv&codec=h264`
3. Add **TV Guide Data Provider** (Select **XMLTV**):
   - **File or URL**: `http://<ip>:18392/xmltv.xml`
4. Save and click **Refresh Guide Data**.

**Note (Windows users):** When using URLs with `&` in Command Prompt, wrap the URL in quotes:
```cmd
mpv "http://falcon:18392/playlist.m3u?backend=qsv&codec=h264"
```

## Data Files
- `channels.conf`: Generated by scanner. stored in `/opt/zaplink/` or CWD.
- `epg.db`: SQLite database for EPG storage.
- `huffman.bin`: Required for decoding certain ATSC EPG strings.

## Notes
- **Series Recording**: The generated XMLTV includes special tags (`<episode-num>`, `<category>Series</category>`) to ensure Jellyfin recognizes recurring shows.
- **VHF Skipping**: During scan, you can choose to skip VHF-LO/HI (RF 2-13) if you only have a UHF antenna.

## License
No license specified.
